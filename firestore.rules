rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidTakeText(text) {
      return text is string && 
             text.size() >= 10 && 
             text.size() <= 500; // Increased limit
    }
    
    function isValidCategory(category) {
      return category is string && 
             category.size() >= 2 && 
             category.size() <= 50;
    }
    
    // Takes collection
    match /takes/{takeId} {
      // Anyone can read approved takes
      allow read: if resource.data.isApproved == true;
      
      // Authenticated users can create takes (but they need approval)
      allow create: if isAuthenticated() &&
                   isValidTakeText(request.resource.data.text) &&
                   isValidCategory(request.resource.data.category) &&
                   request.resource.data.userId == request.auth.uid &&
                   request.resource.data.isApproved == false &&
                   request.resource.data.hotVotes == 0 &&
                   request.resource.data.notVotes == 0 &&
                   request.resource.data.totalVotes == 0 &&
                   request.resource.data.reportCount == 0;
      
      // Only system/admin can update takes (for vote counts and approval)
      // In a real app, you'd have admin permissions here
      // For now, we'll allow updates to vote counts
      allow update: if isAuthenticated() &&
                   // Only allow updating vote counts
                   (request.resource.data.diff(resource.data).affectedKeys()
                    .hasOnly(['hotVotes', 'notVotes', 'totalVotes', 'reportCount']));
    }
    
    // Votes collection
    match /votes/{voteId} {
      // Users can read their own votes
      allow read: if isOwner(resource.data.userId);
      
      // Users can create votes
      allow create: if isAuthenticated() &&
                   request.resource.data.userId == request.auth.uid &&
                   request.resource.data.vote in ['hot', 'not'] &&
                   request.resource.data.takeId is string &&
                   request.resource.data.votedAt is timestamp;
      
      // No updates or deletes allowed for votes
      allow update, delete: if false;
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own data
      allow read: if isOwner(userId);
      
      // Users can create their own user document (more permissive for now)
      allow create: if isOwner(userId);
      
      // Users can update their own data (more permissive for now)
      allow update: if isOwner(userId);
      
      // No deletes allowed
      allow delete: if false;
    }
    
    // Deny all other operations
    match /{document=**} {
      allow read, write: if false;
    }
  }
}